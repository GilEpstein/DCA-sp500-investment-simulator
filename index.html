// נעדכן את פונקציית החישוב
const calculateReturns = () => {
    if (sp500Data.length === 0) return;

    let portfolio = {
        totalInvested: 0,
        finalValue: 0,
        monthlyData: [],
        increasedInvestments: 0  // נוסיף מעקב אחרי מספר ההשקעות המוגדלות
    };

    const monthsToCalculate = params.years * 12;
    const startIndex = Math.max(0, sp500Data.length - monthsToCalculate);
    
    // נשמור את המחיר הגבוה ביותר ב-52 שבועות האחרונים
    let highestPrice52Weeks = 0;
    let pricesLast52Weeks = [];

    for (let i = 0; i < monthsToCalculate && (startIndex + i) < sp500Data.length; i++) {
        let currentInvestment = params.monthlyInvestment;
        const currentPrice = sp500Data[startIndex + i].price;

        // עדכון מערך המחירים של 52 שבועות אחרונים
        pricesLast52Weeks.push(currentPrice);
        if (pricesLast52Weeks.length > 52) {
            pricesLast52Weeks.shift(); // מחיקת המחיר הישן ביותר
        }
        
        // חישוב המחיר הגבוה ביותר ב-52 שבועות האחרונים
        highestPrice52Weeks = Math.max(...pricesLast52Weeks);

        // בדיקת ירידה מהשיא
        if (highestPrice52Weeks > 0) {
            const dropFromHigh = ((highestPrice52Weeks - currentPrice) / highestPrice52Weeks) * 100;
            console.log(`Month ${i}: Current Price: ${currentPrice}, Highest: ${highestPrice52Weeks}, Drop: ${dropFromHigh.toFixed(2)}%`);
            
            if (dropFromHigh >= params.dropPercentage) {
                currentInvestment *= (1 + (params.increasePercentage / 100));
                portfolio.increasedInvestments++;
            }
        }

        // חישוב תשואה חודשית
        const monthReturn = i === 0 ? 1 : currentPrice / sp500Data[startIndex + i - 1].price;
        portfolio.finalValue = (portfolio.finalValue * monthReturn) + currentInvestment;
        portfolio.totalInvested += currentInvestment;

        portfolio.monthlyData.push({
            month: i + 1,
            date: sp500Data[startIndex + i].date,
            invested: portfolio.totalInvested,
            value: portfolio.finalValue,
            currentPrice: currentPrice,
            highestPrice52W: highestPrice52Weeks,
            increasedInvestment: currentInvestment > params.monthlyInvestment
        });
    }

    setResults(portfolio);
    console.log(`מספר פעמים שההשקעה הוגדלה: ${portfolio.increasedInvestments}`);
};
