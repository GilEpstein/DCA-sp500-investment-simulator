<script type="text/babel">
    const { useState, useEffect } = React;
    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

    function App() {
        const [sp500Data, setSP500Data] = useState([]);
        const [params, setParams] = useState({
            monthlyInvestment: 100,
            dropPercentage: 20,
            increasePercentage: 50,
            years: 5
        });
        
        const [results, setResults] = useState({
            totalInvested: 0,
            finalValue: 0,
            returns: []
        });

        useEffect(() => {
            // טעינת נתוני S&P 500 מה-CSV
            fetch('data/sp500_data.csv')
                .then(response => response.text())
                .then(csvText => {
                    Papa.parse(csvText, {
                        header: true,
                        complete: (results) => {
                            const data = results.data
                                .filter(row => row.Date && row.Price) // מסנן שורות לא תקינות
                                .map(row => ({
                                    date: row.Date,
                                    value: parseFloat(row.Price)
                                }))
                                .sort((a, b) => new Date(a.date) - new Date(b.date));
                            setSP500Data(data);
                        },
                        error: (error) => {
                            console.error('Error parsing CSV:', error);
                        }
                    });
                })
                .catch(error => console.error('Error loading CSV:', error));
        }, []);

        const calculateInvestmentReturns = (params) => {
            if (sp500Data.length === 0) return null;

            const {
                monthlyInvestment,
                dropPercentage,
                increasePercentage,
                years
            } = params;

            let portfolio = {
                totalInvested: 0,
                currentValue: 0,
                monthlyData: []
            };

            let lastHighestValue = 0;
            const startIndex = Math.max(0, sp500Data.length - (years * 12));
            
            for (let i = 0; i < years * 12 && (startIndex + i) < sp500Data.length; i++) {
                let currentInvestment = monthlyInvestment;
                const currentPrice = sp500Data[startIndex + i].value;

                if (lastHighestValue > 0) {
                    const dropFromHigh = ((lastHighestValue - currentPrice) / lastHighestValue) * 100;
                    if (dropFromHigh >= dropPercentage) {
                        currentInvestment *= (1 + (increasePercentage / 100));
                    }
                }

                if (currentPrice > lastHighestValue) {
                    lastHighestValue = currentPrice;
                }

                const monthReturn = i === 0 ? 1 : currentPrice / sp500Data[startIndex + i - 1].value;
                portfolio.currentValue = (portfolio.currentValue * monthReturn) + currentInvestment;
                portfolio.totalInvested += currentInvestment;

                portfolio.monthlyData.push({
                    month: i + 1,
                    date: sp500Data[startIndex + i].date,
                    invested: portfolio.totalInvested,
                    value: portfolio.currentValue,
                    price: currentPrice
                });
            }

            return portfolio;
        };

        const handleCalculate = () => {
            const portfolio = calculateInvestmentReturns(params);
            if (portfolio) {
                setResults({
                    totalInvested: portfolio.totalInvested,
                    finalValue: portfolio.currentValue,
                    returns: portfolio.monthlyData
                });
            }
        };

        // ... (שאר הקוד נשאר אותו דבר)
    }
</script>
